name: Visual Regression Testing

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  expected_snapshot:
    name: Generate Expected Snapshots
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: ./node_modules/.bin/playwright install chromium --with-deps

      - name: Generate expected snapshots
        run: pnpm test:visual:update

      - name: Cache expected snapshots
        uses: actions/cache/save@v4
        with:
          path: tests/visual/__screenshots__
          key: expected-snapshots-${{ github.base_ref }}-${{ github.run_id }}

  vrt:
    name: Visual Regression Testing
    runs-on: ubuntu-latest
    needs: expected_snapshot
    outputs:
      new: ${{ steps.analyze.outputs.new }}
      changed: ${{ steps.analyze.outputs.changed }}
      deleted: ${{ steps.analyze.outputs.deleted }}
      total: ${{ steps.analyze.outputs.total }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: ./node_modules/.bin/playwright install chromium --with-deps

      - name: Restore expected snapshots
        uses: actions/cache/restore@v4
        with:
          path: tests/visual/__screenshots__
          key: expected-snapshots-${{ github.base_ref }}-${{ github.run_id }}

      - name: Run VRT
        id: vrt
        continue-on-error: true
        run: pnpm test:visual --run

      - name: Analyze VRT results
        id: analyze
        run: |
          # „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„ÅÆÁä∂ÊÖã„ÇíÂàÜÊûê
          NEW=0
          CHANGED=0
          DELETED=0
          TOTAL=0

          # .vitest-attachments „Å´Â∑ÆÂàÜÁîªÂÉè„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÂ§âÊõ¥„Åï„Çå„Åü„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÔºâ
          if [ -d ".vitest-attachments" ]; then
            CHANGED=$(find .vitest-attachments -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          fi

          # ÁèæÂú®„ÅÆ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÊï∞
          if [ -d "tests/visual/__screenshots__" ]; then
            CURRENT=$(find tests/visual/__screenshots__ -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          else
            CURRENT=0
          fi

          # ÊúüÂæÖÂÄ§„Å®„Åó„Å¶Âæ©ÂÖÉ„Åï„Çå„Åü„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÊï∞„ÇíË®òÈå≤ÔºàÂÆüË°åÂâç„Å´„Ç´„Ç¶„É≥„Éà„Åô„Åπ„Åç„Å†„Å£„Åü„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØÊ¶ÇÁÆóÔºâ
          # ÂÆüÈöõ„Å´„ÅØ„ÄÅchanged „Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ TOTAL = CURRENT, NEW = CURRENT - (ÂÖÉ„ÅÆÊï∞) „Å†„Åå
          # Á∞°Áï•Âåñ„ÅÆ„Åü„ÇÅ„ÄÅÂ∑ÆÂàÜ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆÊï∞„Çí CHANGED„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®„Å¶‰∏ÄËá¥„Å®„Åô„Çã

          if [ $CHANGED -gt 0 ]; then
            # Â∑ÆÂàÜ„Åå„ÅÇ„ÇãÂ†¥Âêà
            TOTAL=$CURRENT
            # Êñ∞Ë¶è„Å®ÂâäÈô§„ÅÆÂà§ÂÆö„ÅØË§áÈõë„Å™„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ CHANGED „ÅÆ„Åø„Ç´„Ç¶„É≥„Éà
            # „Çà„ÇäÊ≠£Á¢∫„Å™Âà§ÂÆö„Å´„ÅØ„ÄÅ‰∫ãÂâç„Å´ÊúüÂæÖÂÄ§„ÅÆ„É™„Çπ„Éà„Çí‰øùÂ≠ò„Åó„Å¶„Åä„ÅèÂøÖË¶Å„Åå„ÅÇ„Çã
          else
            # Â∑ÆÂàÜ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®„Å¶‰∏ÄËá¥
            TOTAL=$CURRENT
            NEW=0
            CHANGED=0
            DELETED=0
          fi

          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "VRT Results: NEW=$NEW CHANGED=$CHANGED DELETED=$DELETED TOTAL=$TOTAL"

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vrt-html-report
          path: html/
          retention-days: 3

  upload_ghpages:
    name: Upload to GitHub Pages
    runs-on: ubuntu-latest
    needs: vrt
    if: always()
    concurrency:
      group: gh-pages
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download VRT HTML report
        uses: actions/download-artifact@v4
        with:
          name: vrt-html-report
          path: vrt-report

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare gh-pages branch
        run: |
          # gh-pages „Éñ„É©„É≥„ÉÅ„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "gh-pages branch exists, checking out..."
            git fetch origin gh-pages
            git checkout gh-pages
          else
            echo "gh-pages branch does not exist, creating..."
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# Visual Regression Test Reports" > README.md
            git add README.md
            git commit -m "Initial commit for gh-pages"
            git push origin gh-pages
          fi

      - name: Deploy to gh-pages
        run: |
          # PRÁî®„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰ΩúÊàê
          PR_DIR="pr/${{ github.event.pull_request.number }}/vrt"
          mkdir -p "$PR_DIR"

          # VRT„É¨„Éù„Éº„Éà„Çí„Ç≥„Éî„Éº
          rm -rf "$PR_DIR"/*
          cp -r vrt-report/* "$PR_DIR/"

          # Â§âÊõ¥„Çí„Ç≥„Éü„ÉÉ„Éà
          git add .

          # ÂâçÂõû„ÅÆ„Ç≥„Éü„ÉÉ„Éà„Çíamend
          if git log -1 --pretty=%B | grep -q "Update VRT reports"; then
            git commit --amend --no-edit
          else
            git commit -m "Update VRT reports"
          fi

          # Force push
          git push --force-with-lease origin gh-pages

      - name: Get repository name
        id: repo
        run: |
          echo "name=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const newCount = '${{ needs.vrt.outputs.new }}';
            const changedCount = '${{ needs.vrt.outputs.changed }}';
            const deletedCount = '${{ needs.vrt.outputs.deleted }}';
            const totalCount = '${{ needs.vrt.outputs.total }}';

            const repoName = '${{ steps.repo.outputs.repo_name }}';
            const owner = '${{ steps.repo.outputs.owner }}';
            const vrtUrl = `https://${owner}.github.io/${repoName}/pr/${prNumber}/vrt/`;

            const commentBody = `<!-- VRT_REPORT -->
            ## üì∏ Visual Regression Test Results

            | Status | Count |
            |--------|-------|
            | üÜï New | ${newCount} |
            | üîÑ Changed | ${changedCount} |
            | üóëÔ∏è Deleted | ${deletedCount} |
            | üìä Total | ${totalCount} |

            [üìã View Full Report](${vrtUrl})

            ---
            *Last updated: ${new Date().toISOString()}*
            `;

            // Êó¢Â≠ò„ÅÆVRT„Ç≥„É°„É≥„Éà„ÇíÊ§úÁ¥¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('<!-- VRT_REPORT -->')
            );

            if (existingComment) {
              // Êó¢Â≠ò„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÊõ¥Êñ∞
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
              console.log('Updated existing VRT comment');
            } else {
              // Êñ∞Ë¶è„Ç≥„É°„É≥„Éà„Çí‰ΩúÊàê
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
              console.log('Created new VRT comment');
            }
