name: Visual Regression Testing

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  expected_snapshot:
    name: Generate Expected Snapshots
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: ./node_modules/.bin/playwright install chromium --with-deps

      - name: Generate expected snapshots
        run: pnpm test:visual:update

      - name: Cache expected snapshots
        uses: actions/cache/save@v4
        with:
          path: tests/visual/__screenshots__
          key: expected-snapshots-${{ github.base_ref }}-${{ github.run_id }}

  vrt:
    name: Visual Regression Testing
    runs-on: ubuntu-latest
    needs: expected_snapshot
    outputs:
      new: ${{ steps.analyze.outputs.new }}
      changed: ${{ steps.analyze.outputs.changed }}
      deleted: ${{ steps.analyze.outputs.deleted }}
      passed: ${{ steps.analyze.outputs.passed }}
      has_diff: ${{ steps.analyze.outputs.has_diff }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: ./node_modules/.bin/playwright install chromium --with-deps

      - name: Restore expected snapshots
        uses: actions/cache/restore@v4
        with:
          path: tests/visual/__screenshots__
          key: expected-snapshots-${{ github.base_ref }}-${{ github.run_id }}

      - name: Run VRT
        id: vrt
        continue-on-error: true
        run: pnpm test:visual --run

      - name: Analyze VRT results
        id: analyze
        run: |
          # vitest-results.json ã‹ã‚‰çµæœã‚’è§£æ
          if [ ! -f "__vrt-result__/vitest-results.json" ]; then
            echo "vitest-results.json not found"
            echo "new=0" >> $GITHUB_OUTPUT
            echo "changed=0" >> $GITHUB_OUTPUT
            echo "deleted=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "has_diff=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # JSON ã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
          TOTAL=$(jq '.numTotalTests' __vrt-result__/vitest-results.json)
          PASSED=$(jq '.numPassedTests' __vrt-result__/vitest-results.json)
          FAILED=$(jq '.numFailedTests' __vrt-result__/vitest-results.json)

          # å·®åˆ†ã®è©³ç´°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          # failedãƒ†ã‚¹ãƒˆã®ä¸­ã‹ã‚‰å®Ÿéš›ã®å·®åˆ†ã‚’å–å¾—
          CHANGED=0
          if [ -d ".vitest-attachments" ]; then
            CHANGED=$(find .vitest-attachments -name "*-actual-*.png" 2>/dev/null | wc -l | tr -d ' ')
          fi

          # æ–°è¦ãƒ»å‰Šé™¤ã®åˆ¤å®š
          # CHANGED ãŒ FAILED ã¨ç­‰ã—ã„å ´åˆã¯æ—¢å­˜ãƒ†ã‚¹ãƒˆã®å¤‰æ›´ã®ã¿
          # FAILED > CHANGED ã®å ´åˆã¯æ–°è¦è¿½åŠ ã®å¯èƒ½æ€§
          NEW=0
          DELETED=0

          if [ $FAILED -gt $CHANGED ]; then
            # å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ä¸­ã«å·®åˆ†ç”»åƒãŒãªã„ã‚‚ã®ã¯æ–°è¦
            NEW=$((FAILED - CHANGED))
          fi

          HAS_DIFF="false"
          if [ $CHANGED -gt 0 ] || [ $NEW -gt 0 ]; then
            HAS_DIFF="true"
          fi

          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "has_diff=$HAS_DIFF" >> $GITHUB_OUTPUT

          echo "VRT Results: NEW=$NEW CHANGED=$CHANGED DELETED=$DELETED PASSED=$PASSED TOTAL=$TOTAL HAS_DIFF=$HAS_DIFF"

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vrt-html-report
          path: __vrt-result__/html/
          retention-days: 3

  upload_ghpages:
    name: Upload to GitHub Pages
    runs-on: ubuntu-latest
    needs: vrt
    if: always()
    concurrency:
      group: gh-pages
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download VRT HTML report
        uses: actions/download-artifact@v4
        with:
          name: vrt-html-report
          path: vrt-report

      - name: Get repository name
        id: repo
        run: |
          echo "name=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Insert base tag into HTML report
        run: |
          REPO_NAME="${{ steps.repo.outputs.repo_name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_PATH="/${REPO_NAME}/pr/${PR_NUMBER}/vrt/"

          # index.html ã« <base> ã‚¿ã‚°ã‚’æŒ¿å…¥
          if [ -f "vrt-report/index.html" ]; then
            sed -i "s|<head>|<head>\n  <base href=\"${BASE_PATH}\">|" vrt-report/index.html
            echo "Inserted <base href=\"${BASE_PATH}\"> into index.html"
          else
            echo "Warning: vrt-report/index.html not found"
          fi

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare gh-pages branch
        run: |
          # gh-pages ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "gh-pages branch exists, checking out..."
            git fetch origin gh-pages
            git checkout gh-pages
          else
            echo "gh-pages branch does not exist, creating..."
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# Visual Regression Test Reports" > README.md
            git add README.md
            git commit -m "Initial commit for gh-pages"
            git push origin gh-pages
          fi

      - name: Deploy to gh-pages
        run: |
          # PRç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          PR_DIR="pr/${{ github.event.pull_request.number }}/vrt"
          mkdir -p "$PR_DIR"

          # VRTãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
          rm -rf "$PR_DIR"/*
          cp -r vrt-report/* "$PR_DIR/"

          # vrt-reportãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
          rm -rf vrt-report

          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add .

          # å‰å›ã®ã‚³ãƒŸãƒƒãƒˆã‚’amend
          if git log -1 --pretty=%B | grep -q "Update VRT reports"; then
            git commit --amend --no-edit
          else
            git commit -m "Update VRT reports"
          fi

          # Force push
          git push --force-with-lease origin gh-pages

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const newCount = '${{ needs.vrt.outputs.new }}';
            const changedCount = '${{ needs.vrt.outputs.changed }}';
            const deletedCount = '${{ needs.vrt.outputs.deleted }}';
            const passedCount = '${{ needs.vrt.outputs.passed }}';
            const hasDiff = '${{ needs.vrt.outputs.has_diff }}' === 'true';

            const repoName = '${{ steps.repo.outputs.repo_name }}';
            const owner = '${{ steps.repo.outputs.owner }}';
            const vrtUrl = `https://${owner}.github.io/${repoName}/pr/${prNumber}/vrt/`;

            const localReproductionSteps = `
            <details>
            <summary>ğŸ”§ ãƒ­ãƒ¼ã‚«ãƒ«ã§å†ç¾ã™ã‚‹æ–¹æ³•</summary>

            \`\`\`bash
            # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆ
            git checkout ${{ github.base_ref }}
            pnpm install
            pnpm test:visual:update --run

            # PRãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆã¦VRTã‚’å®Ÿè¡Œ
            git checkout ${{ github.head_ref }}
            pnpm install
            pnpm test:visual --run

            # ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª
            pnpm exec vite preview --outDir __vrt-result__/html
            \`\`\`

            </details>
            `;

            let commentBody = '';

            if (!hasDiff) {
              // å·®åˆ†ãŒãªã„å ´åˆ
              commentBody = `<!-- VRT_REPORT -->
            ## ğŸ“¸ Visual Regression Test Results

            ### âœ¨ å·®åˆ†ãªã—ï¼ã‚„ã£ãŸã­ï¼ ğŸ‰

            å…¨ã¦ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆ${passedCount}ä»¶ï¼‰ãŒãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚

            [ğŸ“‹ View Full Report](${vrtUrl})

            ${localReproductionSteps}

            ---
            *Last updated: ${new Date().toISOString()}*
            `;
            } else {
              // å·®åˆ†ãŒã‚ã‚‹å ´åˆ
              commentBody = `<!-- VRT_REPORT -->
            ## ğŸ“¸ Visual Regression Test Results

            | Status | Count |
            |--------|-------|
            | ğŸ†• New | ${newCount} |
            | ğŸ”„ Changed | ${changedCount} |
            | ğŸ—‘ï¸ Deleted | ${deletedCount} |
            | âœ… Passed | ${passedCount} |

            [ğŸ“‹ View Full Report](${vrtUrl})

            ${localReproductionSteps}

            ---
            *Last updated: ${new Date().toISOString()}*
            `;
            }

            // æ—¢å­˜ã®VRTã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('<!-- VRT_REPORT -->')
            );

            if (existingComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
              console.log('Updated existing VRT comment');
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
              console.log('Created new VRT comment');
            }
